# Documentation
## Project Details
- **Project Name**:
    - Server
- **Team members and contributions**:
    - *wfu16*:
        - User Story 1
        - CSV
        - less User Story 2
        - testing
        - documentation
    - *dsaunde2*:
        - CSV
        - most User Story 2
        - User Story 3
        - testing
- **Total estimated time**:
    - 20 hours
- A link to [our repo](https://github.com/julia-fu0528/Server)

## Design Choices
- **Main Directory**
    - *Handlers*
        - *LoadHandler*
            - Endpoint "loadcsv", with query "filepath"
            - MissingFilePathResponse if no query at key "filepath" is provided
            - InaccessibleCSVResponse if the value provided at query "filepath" is not found
            - CSVParsingFailureResponse if error occurs when parsing the csv file
            - CSVParsingSuccessResponse if csv file is successfully retrieved and parsed
                - *result*: "success"
                - *filepath*: the given query value
                - *message*: "CSV File ... successfully stored. Contents accessible in endpoint viewcsv"
        - *ViewHandler*
            - Endpoint "viewcsv"
            - ViewCSVFailureResponse if no csv file has been loaded yet
            - ViewCSVSuccessResponse if csv file has been loaded
                - *result*: "success"
                - *data*: parsed csv file output as a 2d array in Json
                - *message*: "File available for view."
        - *SearchHandler*
            - Endpoint "searchcsv", with queries "column" and "value". "column" can be index or header. 
            - MissingColumnResponse if no query at key "column" is provided
            - MissingValueResponse if no query at key "value" is provided
            - SearchFailureResponse if search fails
            - ValueNotFoundResponse if the value is not found at the given column
            - SearchSuccessResponse if the value is found at the given column
                - *result*: "success"
                - *data*: rows where the value is present in the given column, presented as 2d array in Json
                - *column*: the given query value at key "column"
                - *value*: the given query value at key "value"
                - *message*: "Value successfully searched"
    - *Weather*
        - *Requester*
            - interface 
            - contains generic method requestToInstantiate with inputs as follows:
                - String url: the website to access
                - generic class goalClass: the class to deserialize Json into
        - *PlainRequester*
            - implements the interface Requester
            - installs generic method requestToInstantiate:
                - if the api is in correct state 200, then deserialize the information on the webpage of the url
        - *Data*
            - records of Json data retrieved from web api
            - *Forecast*: double "temperature" + String "temperatureUnit"
            - *ForecastProperties*: periods of the forecast, in the type of a list of Forecast
            - *WeatherResponse*: properties of weather, in the type of ForecastProperties
            - *GridResponse*: 
               - properties of response, in the type of GridProperties
               - title of the gridresponse, as a String
            - *GridProperties*: String endpoint
        - *WeatherCachingProxy*
            - instance variables:
                - cache: of type LoadingCache of a list of doubles and WeatherResponse
                - distance: double representing the distance between two locations
                - weatherResponse: WeatherResponse representing the properties of weather
                - Requester: able to deserialize Json string from browser url webpage
            - caching:
                - maxSize: the maximum size of our cache is 100
                - expirationTime: the maximum amount that a cached element can remain is 10 minutes
                - requester: mocked requester that works with weather API requester
            - WeatherCachingProxy:
                - creates a caching proxy that wraps around the requester instance variable
                - when the requestToInstantiate() method is called with a new URL, it first checks if the requested URL is present in the cache 
                   - If it is, it returns the cached value immediately without making a new request
                   - If it not, the requestToInstantiate() method is called on the requester instance variable to make a new request and get the response. 
                - The response is then added to the cache so that subsequent requests for the same URL can be returned from the cache without making new requests.
            - getForecast:
                - inputs two doubles representing the latitude and longitude of the location
                - returns weather forecast as a record Forecast
                - throws ExecutionException
                - If the location is close enough to the already cached locations, the the cached weather forecast of that close enough location is returned
                - If not, a new weather response of this new location is added into the caching, and this information is returned
            - getWeatherResponse:
                - returns weather response as a record WeatherResponse
            - getCurrentTime:
                - returns the time when the weather information is retrieved
                - returned as a String containing Year, month, day, hours, minutes, and seconds
            - getCacheState:
                - returns cached information as the ConcurrentMap of a list of doubles with WeatherResponse
        - *WeatherHandler*
            - private instance variable cache: of class WeatherCachingProxy
            - if no "lat" or "lon" queries are entered, then respond with "error_bad_request"
            - the weather information of that location represented by lat and lon is either retrieved from cache or added to cache
            - if the retrieved information either from the cache or from NWS is null, then respond with "error_datasource"
            - in the case of NumberFormatException if the inputs are not doubles, respond with "error_bad_request"
            - in the case of other Exceptions, respond with "error_internal"
    - *Servers*
        - *LoadedFiles*
            - field: generic type storage
            - method getFile: returns storage, raises NoFileStoredException when storage is null
            - method storeFile: void, changes the value of the field storage to the given file
        - *Server*
            - the main class
            - initiates the "loadcsv", "viewcsv", "searchcsv", and "weather" endpoints
    - *Exceptions*
        - FileNotFoundException, NoFileStoredException, SearchFailureException
    - *CSV*
        - Algos: CSVParser and Search classes
        - CSVMain: main class for CSV
        - RowCreators: the two creators that developers might want for the csv rows
            - Person: new data structure Person
            - RowCreator: List of Strings
    - *data*
        - made example files: csv files that are either empty or nonempty, either with headers or without headers
        - given example files: stardata and ten-star csv
- **test Directory**
    - *TestSuites*
        - TestLoad: tests "loadcsv"
        - TestView: tests "viewcsv" 
        - TestSearch: tests "searchcsv" 
        - TestWeather: tests "weather"
      
## Errors/Bugs
- We currently don't have any errors or bugs.

## Tests
- *The following each points out the purpose of each individual test, sequentially.*
    - **Loadcsv**
        - MissingFilePathResponse: missing filepath query
        - InaccessibleCSVResponse: filepath doesn't exist
        - CSVParsingSyccessResponse: empty file
        - CSVParsingSuccessResponse: basic file
    - **Viewcsv**
        - ViewCSVFailureResponse: No csv stored yet
        - ViewCSVSuccessResponse: empty csv
        - ViewCSVSuccessResponse: empty csv with headers
        - ViewCSVSuccessResponse: small csv
        - ViewCSVSuccessResponse: large csv
    - **Searchcsv**
        - MissingColumnResponse: no column query
        - MissingValueResponse: no value query
        - SearchFailureResponse: no value found
        - SearchSuccessResponse: column index
        - SearchSuccessResponse: column header
        - SearchSuccessResponse: single row
        - SearchSuccessResponse: multiple rows
    - **Weather**
        - WeatherSuccessResponse: correct input
        - WeatherSuccessResponse: very long coordinates
        - WeatherFailureResponse: invalid coordinates
        - WeatherFailureResponse: missing latitude
        - WeatherFailureResponse: missing longitude
        - WeatherFailureResponse: input coordinates as strings
  
## How To
- **Run the Tests**
    - JUnit test
- **Build our program**
    - First provide the backend csv parser and searcher
    - build the handlers
    - provide the data
    - Then implement the server
- **Run our program**
    - enter "localhost:3232/" in the browser
    - "loadcsv": enter "loadcsv" as endpoint, then specify the filepath with the query "filepath"
    - "viewcsv": enter "viewcsv" as endpoint. Remember to load csv before viewing it
    - "searchcsv": enter "searchcsv" as endpoint
        - specify the column index/header with the query "column"
        - specify the value to search for with the query "value"
    - "weather": enter "weather" as endpoint
        - specify the latitude of the target location with the query "lat"
        - specify the longitude of the target location with the query "lon"
- **Control the cache-matching and cache-eviction for weather requests**
    -  *Cache-matching*
        - Caching is created by mapping the record WeatherResponse to a List of Doubles
        - Cache matching can be controlled by controlling or changing the following key and value
        - key: List of Doubles containing two numbers that represent the coordinates of a location
            - the first double in the list is the latitude of the location
            - the second double in the list is the longitude of the location
        - value: 
            - WeatherResponse is created by creating a PlainRequester from a String gridUrl
            - a GridResponse is created by deserializing the Json information retrieved from the webpage of the gridUrl
            - a String is created by getting the Json forecast of the GridResponse
            - a WeatherResponse is created by deserializing the Json forecast
    - *Cache-eviction*
        - cache eviction is achieved by the method getForecast in the class WeatherCachingProxy from directory Weather
        - cache eviction can be controlled by controlling or changing the following: 
        - the distance between the location representing by the given latitude and longitude and each of the cached locations are calculated
        - if the distance is small enough(criteria can be controlled by developer), then cached information is evicted
        - if the distance is not small enough, then information is retrieved from NWS and then a newly matched map is cached